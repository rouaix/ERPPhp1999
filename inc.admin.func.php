<?phpif (file_exists("securite.php")){include("securite.php");}$droits = cherche_droits();while (list($key, $val) = @each($droits)){  if($val["droits"] == "droits" && $val["type"] == "table"){$liste_droits_tables[$val["id"]] = $val;}  if($val["droits"] == "droits" && $val["type"] == "champs"){$liste_droits_champs[$val["id"]] = $val;}    if($val["type"] == "droits" && $val["lien"] == 0){$droits_tables[$val["id"]] = $val;}  if($val["type"] == "droits" && $val["lien"] != ""){$droits_champs[$val["id"]] = $val;}}unset($droits);switch (@$_SESSION["montre"]) {  default :    echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?montre=listedestables\"><img src=\"".$_SESSION["ico"]["voir"]."\" class=\"admin\"><b>Liste des tables</b></a></div>\n";    echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?montre=droitsdestables\"><img src=\"".$_SESSION["ico"]["voir"]."\" class=\"admin\"><b>Droits des tables</b></a></div>\n";    echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?montre=cartedestables\"><img src=\"".$_SESSION["ico"]["orange"]."\" class=\"admin\"><b>Cr&eacute;ation de la carte des tables</b></a></div>\n";  break;    case "droitsdeschamps" :    echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&montre=droitsdestables\" title=\"Retour !\"><img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\"><b>Droits des champs</b></a> (".ucfirst(@$_SESSION["table"]).")</div>\n";      echo "<div class=\"admin\" id=\"fixe\" style=\"text-align:center;\">";      echo "<form enctype=\"multipart/form-data\" method=\"post\" action=\"".$_SESSION["lien"]."\">\n";      echo "<input type=\"hidden\" name=\"action\" value=\"sauvedata\">";      echo "<input type=\"hidden\" name=\"table\" value=\"tables\">";      echo "<input type=\"hidden\" name=\"form_horloge\" value=\"\">";      echo "<input type=\"hidden\" name=\"form_pere\" value=\"\">";      echo "<input type=\"hidden\" name=\"form_droits\" value=\"droits\">";      echo "<input type=\"hidden\" name=\"form_type\" value=\"champs\">";      echo "<input type=\"hidden\" name=\"form_systeme\" value=\"\">";      echo "<input type=\"hidden\" name=\"retourtable\" value=\"".@$_SESSION["table"]."\">";      echo "<label>Ajouter un droit</label>";      echo "<input type=\"text\" name=\"form_nom\" value=\"\">";      echo "</form>";      echo "</div>\n";    echo "<div class=\"admin\">";        $result = mysql_query("SHOW FULL COLUMNS FROM ".@$_SESSION["table"]);    while($ligne = mysql_fetch_assoc($result)){$champs[$ligne["Field"]] = $ligne['Comment'];}    echo "<table>\n";    echo "<tr>\n";    echo "<td class=\"admin\" id=\"nom\"><b>Champs</b></td>\n";        @reset($liste_droits_champs);    while (list($key, $val) = @each($liste_droits_champs)){      echo "<td class=\"admin\" id=\"droits\">";      echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=tables&retourtable=".@$_SESSION["table"]."&action=effaceligne&effaceligne=".$val["id"]."\" title=\"Supprimer !\"><img src=\"".$_SESSION["ico"]["rouge"]."\" id=\"image10\"></a>&nbsp;&nbsp;&nbsp;";      echo "<b>".ucfirst($val["nom"])."</b>";      echo "</td>\n";    }    echo "</tr>\n";        while (list($k_champs, $val) = each($champs)){      echo "<tr>\n";      echo "<td class=\"admin\" id=\"nom\"><b>".ucfirst($k_champs)."</b></td>\n";      //----------------------            @reset($liste_droits_champs);      while (list(, $liste) = @each($liste_droits_champs)){        echo "<td class=\"admin\" id=\"droits\">";        $ok = verif_droit_champs($liste["nom"],$k_champs,@$_SESSION["table"],@$droits_champs);        if (is_array($ok)){          echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=tables&retourtable=".@$_SESSION["table"]."&action=effaceligne&effaceligne=".$ok["id"]."\" title=\"Annuler !\">";          echo "<img src=\"".$_SESSION["ico"]["vert"]."\" class=\"admin\">";          echo "</a>";        }else{          echo "<a class=\"admin\" href=\"".$_SESSION["lien"];          echo "?table=tables";          echo "&form_type=droits";          echo "&form_nom=".$k_champs;          echo "&action=sauvedata";          echo "&form_lien=".@$_SESSION["table"];          echo "&retourtable=".@$_SESSION["table"];          echo "&form_droits=".$liste["nom"];          echo "\" title=\"Autoriser !\">";          echo "<img src=\"".$_SESSION["ico"]["gris"]."\" class=\"admin\">";          echo "</a>";        }        echo "</td>\n";      }            //----------------------      echo "</tr>\n";    }    echo "</table>\n";    echo "</div>";        unset($x);    unset($champs);    unset($listedroits);        //echo "<div class=\"admin\" id=\"fixe\"><b>Liste des Droits</b></div>\n";    //$sql ="select * from tables where nom='champs' and type='droits' and systeme='droits'";    //$result = mysql_query($sql)or die("erreur ".@$_SESSION["table"]." !");    //while ($ligne = mysql_fetch_array($result)){      //echo "<div class=\"admin\" id=\"fixe\">";      //echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=tables&retourtable=".@$_SESSION["table"]."&action=effaceligne&effaceligne=".$ligne["id"]."\" title=\"Supprimer !\">";      //echo "<img src=\"".$_SESSION["ico"]["rouge"]."\" id=\"image10\"></a>\n";      //echo "&nbsp;<b>".ucfirst($ligne["droits"])."</b>";      //echo "</div>\n";    //}  break;    case "droitsdestables" :    echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?table=&montre=\" title=\"Retour !\"><img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\"><b>Droits des tables</b></a></div>\n";      echo "<div class=\"admin\" id=\"fixe\" style=\"text-align:center;\">";      echo "<form enctype=\"multipart/form-data\" method=\"post\" action=\"".$_SESSION["lien"]."\">\n";      echo "<input type=\"hidden\" name=\"action\" value=\"sauvedata\">";      echo "<input type=\"hidden\" name=\"table\" value=\"tables\">";      echo "<input type=\"hidden\" name=\"form_horloge\" value=\"\">";      echo "<input type=\"hidden\" name=\"form_pere\" value=\"\">";      echo "<input type=\"hidden\" name=\"form_droits\" value=\"droits\">";      echo "<input type=\"hidden\" name=\"form_type\" value=\"table\">";      echo "<input type=\"hidden\" name=\"form_systeme\" value=\"\">";      echo "<input type=\"hidden\" name=\"retourtable\" value=\"".@$_SESSION["table"]."\">";      echo "<label>Ajouter un droit</label>";      echo "<input type=\"text\" name=\"form_nom\" value=\"\">";      echo "</form>";    echo "</div>\n";    echo "<div class=\"admin\">";    echo "<table>\n";    echo "<tr>\n";    echo "<td class=\"admin\" id=\"nom\"><b>Table</b></td>\n";    @reset($liste_droits_tables);    while (list($key, $val) = @each($liste_droits_tables)){      echo "<td class=\"admin\" id=\"droits\">";      echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=tables&retourtable=".@$_SESSION["table"]."&action=effaceligne&effaceligne=".$val["id"]."\" title=\"Supprimer !\"><img src=\"".$_SESSION["ico"]["rouge"]."\" id=\"image10\"></a>&nbsp;&nbsp;&nbsp;";      echo "<b>".ucfirst($val["nom"])."</b>";      echo "</td>\n";    }    echo "</tr>\n";    $result = mysql_query("SHOW TABLES FROM ".$_SESSION["base"]);    while ($ligne = mysql_fetch_row($result)){      echo "<tr>\n";      echo "<td class=\"admin\" id=\"nom\">";      echo "<a class=\"admin\" title=\"Droits des champs !\" href=\"".$_SESSION["lien"]."?table=".$ligne[0]."&montre=droitsdeschamps\">";      echo "<img src=\"".$_SESSION["ico"]["jaune"]."\" class=\"admin\">";      echo "<b>".ucfirst($ligne[0])."</b>\n";      echo "</a>";      echo "</td>\n";      @reset($liste_droits_tables);      while (list(,$liste_tables) = @each($liste_droits_tables)){              //$ok = verif_droit_table($droits,$table,$droits_table);                $ok = verif_droit_table($liste_tables["nom"],$ligne[0],@$droits_tables);                echo "<td class=\"admin\" id=\"droits\">";        if($ok > 0){          echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=tables&retourtable=".$ligne[0]."&action=effaceligne&effaceligne=".$ok["id"]."\" title=\"Annuler !\">";          echo "<img src=\"".$_SESSION["ico"]["vert"]."\" class=\"admin\">";          echo "</a>";        }else{          echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?";          echo "table=tables";          echo "&retourtable=".$ligne[0];          echo "&form_type=droits";          echo "&action=sauvedata";          echo "&form_nom=".$ligne[0];          echo "&form_droits=".$liste_tables["nom"];          echo "\" title=\"Autoriser !\">";          echo "<img src=\"".$_SESSION["ico"]["gris"]."\" class=\"admin\">";          echo "</a>";        }        echo "</td>\n";      }      echo "</tr>\n";    }    echo "</table>\n";    echo "</div>\n";    unset($temp);  break;  case "cartedestables" :      $Fnm = "fichiers/fichiers/fichiers/cartes/Tables.mm";      $inF = fopen($Fnm,"w");      $texte = "<map version=\"0.9.0\">\n";      $texte .="<!-- To view this file, download free mind mapping software FreeMind from http://freemind.sourceforge.net -->\n";      $texte .= "<node BACKGROUND_COLOR=\"#ffffff\" CREATED=\"1\" ID=\"1\" MODIFIED=\"1\" STYLE=\"fork\" TEXT=\"Liste et structure des tables\">\n";      $texte .= "<edge STYLE=\"sharp_linear\" WIDTH=\"1\"/>\n";      $texte .= "<node CREATED=\"1\" ID=\"2\" MODIFIED=\"1\" STYLE=\"bubble\" TEXT=\"".ucfirst($_SESSION["base"])."\">\n";      $cid = 10;      $result = mysql_query("SHOW TABLES FROM ".$_SESSION["base"]);      while ($row = mysql_fetch_row($result)){        $cid ++;        $pid = 10;        $texte .= "<node BACKGROUND_COLOR=\"#ffe76d\" CREATED=\"2\" ID=\"1_".$cid."\" MODIFIED=\"2\" STYLE=\"bubble\" FOLDED=\"true\" TEXT=\"".ucfirst($row[0])."\">\n";        $rc = mysql_query("SHOW FULL COLUMNS FROM ".$row[0]);        while($ligne = mysql_fetch_assoc($rc)){          $pid ++ ;          $texte .= "<node CREATED=\"".$cid."\" ID=\"".$cid."_".$pid."\" MODIFIED=\"".$cid."\" STYLE=\"bubble\" FOLDED=\"true\" TEXT=\"".ucfirst($ligne["Field"])."\">\n";          //$texte .= "<node CREATED=\"".$pid."\" ID=\"\" MODIFIED=\"".$pid."\" FOLDED=\"true\" STYLE=\"bubble\" TEXT=\"\"/>\n";          $texte .= "<node CREATED=\"".$cid."\" ID=\"".$cid."_".$pid."_1\" MODIFIED=\"".$cid."\" STYLE=\"bubble\" TEXT=\"";          while(list($key,$val) = each($ligne)){$texte .= $key." = ".$val."&#xa;";}          $texte .= "\"/>\n";          $texte .= "</node>\n";        }        $texte .= "</node>\n";      }      $texte .= "</node>\n";      $texte .= "</node>\n";      $texte .= "</map>\n";      fwrite($inF,$texte);      fclose($inF);             echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?page=carte&carte=Tables.mm\" title=\"Afficher\"><img src=\"".$_SESSION["ico"]["voir"]."\" class=\"admin\"><b>Cliquer ici pour voir la carte</b></a></div>\n";      unset($_SESSION["montre"]);  break;  case "listedestables" :      echo "<div class=\"admin\" id=\"fixe\"><a class=\"admin\" href=\"".$_SESSION["lien"]."?table=&montre=\" title=\"Retour !\">";      echo "<img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\"><b>Liste des tables</b></a></div>\n";      echo "<div class=\"admin\" id=\"fixe\" style=\"text-align:center;\">";      echo "<form enctype=\"multipart/form-data\" method=\"post\" action=\"".$_SESSION["lien"]."\">\n";      echo "<input type=\"hidden\" name=\"action\" value=\"creationtable\">";      echo "<label>Nouvelle table</label>";      echo "<input type=\"text\" name=\"creationtable\" value=\"\">";      //echo "<br><input type=\"image\" value=\"Valider\" id=\"image16\" style=\"margin:5px;\" src =\"".$_SESSION["ico"]["valider"]."\" title=\"Cliquez pour valider\">";      echo "</form>";      echo "</div>\n";    $result = mysql_query("SHOW TABLE STATUS FROM ".$_SESSION["base"]);    while($ligne = mysql_fetch_assoc($result)){$status[$ligne["Name"]]=$ligne["Comment"];}    $sql = "SHOW TABLES FROM ".$_SESSION["base"];    $result = mysql_query($sql);    while ($row = mysql_fetch_row($result)){      $nresult = mysql_query("SELECT * FROM ".$row[0]."");      $num_rows = mysql_num_rows($nresult);      echo "<div class=\"admin\" id=\"fixe\">";      echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?effacetable=".$row[0]."&action=effacetable&retourtable=".@$_SESSION["table"]."\" title=\"Supprimer !\">";      echo "<img src=\"".$_SESSION["ico"]["rouge"]."\" id=\"image10\"></a>\n";      echo "&nbsp;&nbsp;&nbsp;";      if($num_rows > 0){        echo "<a class=\"admin\" title=\"Voir le contenu de la table !\" href=\"".$_SESSION["lien"]."?table=$row[0]&montre=contenutable\"><b>".ucfirst($row[0])."</b> [".$num_rows."]</a>";        echo "<i> (".$status[$row[0]].")</i>";      }else{        echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=".$row[0]."&montre=nouvelleligne\" title=\"Ajouter !\"><img src=\"".$_SESSION["ico"]["ajouter"]."\" class=\"admin\"></a>";        echo "<b>".ucfirst($row[0])."</b>";      }      echo "</div>\n";    }    unset($status);   break;   case "contenutable" :    $result = mysql_query("SHOW FULL COLUMNS FROM ".@$_SESSION["table"]);    while($ligne = mysql_fetch_assoc($result)){$status[$ligne["Field"]] = $ligne['Comment'];}    echo "<div class=\"admin\" id=\"fixe\">";    if(@$_SESSION["table"]!=""){      echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&montre=listedestables\" title=\"Retour !\"><img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\"></a>\n";    }    echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&montre=nouvelleligne\" title=\"Ajouter !\"><img src=\"".$_SESSION["ico"]["ajouter"]."\" class=\"admin\"></a>\n";    echo "Contenu de la table (".@$_SESSION["table"].")";    echo "</div>\n";    $sql ="select * from ".@$_SESSION["table"]." order by id desc";    $result = mysql_query($sql)or die("erreur ".@$_SESSION["table"]." !");    while ($ligne = mysql_fetch_array($result)) {      echo "<div class=\"admin\" id=\"fixe\">";      echo "<a class=\"admin\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&retourtable=".@$_SESSION["table"]."&action=effaceligne&effaceligne=".$ligne["id"]."\" title=\"Supprimer !\">";      echo "<img src=\"".$_SESSION["ico"]["rouge"]."\" id=\"image10\"></a>\n";      echo "&nbsp;&nbsp;&nbsp;";      echo lien_editer($ligne);      echo "</a>\n";      echo "</div>\n";            }    unset($status);  break;  case "editionligne" :    echo "<div class=\"admin\" id=\"fixe\">";    echo "<a class=\"admin\" title=\"Retour !\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&montre=contenutable\">";    echo "<img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\">";    echo "Edition de l'enregistrement N°".$_SESSION["id"]." de la table (".@$_SESSION["table"].")";    echo "</a>\n";    echo "</div>";    $sql ="select * from ".@$_SESSION["table"]." where id='".$_SESSION["id"]."'";    $result = mysql_query($sql)or die("erreur ".@$_SESSION["table"]." !");    while ($ligne = mysql_fetch_array($result)){      echo "<div class=\"admin\" id=\"fixe\">";      echo "<form class=\"admin\" enctype=\"multipart/form-data\" method=\"post\" action=\"".$_SESSION["lien"]."\">\n";      echo "<input type=\"hidden\" name=\"action\" value=\"sauvedata\">";      echo "<input type=\"hidden\" name=\"table\" value=\"".@$_SESSION["table"]."\">";      echo "<table>\n";      while(list($key,$val) = each($ligne)){        if(is_string($key)){          $val = html_entity_decode($val, ENT_QUOTES, 'UTF-8');          echo "<tr><td class=\"admin\" id=\"nom\">".strtoupper($key)."</td><td class=\"admin\" id=\"champs\"><input class=\"admin\" type=\"text\" name=\"form_".$key."\" value=\"".$val."\"></td></tr>\n";        }      }      echo "<tr><td colspan=\"2\" style=\"text-align:center;\"><input type=\"image\" src=\"".$_SESSION["ico"]["valider"]."\" value=\"Valider\"  id=\"image32\" title=\"Cliquez pour valider\"></td></tr>\n";      echo "</table>\n";      echo "</form>\n";      echo "</div>";    }    unset($_SESSION["id"]);   break;  case "nouvelleligne" :    //$z = nouvelle_idu(@$_SESSION["table"]);    echo "<div class=\"admin\" id=\"fixe\">";    echo "<a class=\"admin\" title=\"Retour !\" href=\"".$_SESSION["lien"]."?table=".@$_SESSION["table"]."&montre=contenutable\">";    echo "<img src=\"".$_SESSION["ico"]["retour"]."\" class=\"admin\">";    echo "Nouvel enregistrement dans la table (".@$_SESSION["table"].")";    echo "</a>\n";    echo "</div>";    $result = @mysql_query("SHOW FULL COLUMNS FROM ".@$_SESSION["table"]);    while($ligne = @mysql_fetch_assoc($result)){$status[$ligne["Field"]] = $ligne['Comment'];}    echo "<div class=\"admin\" id=\"fixe\">";    echo "<form enctype=\"multipart/form-data\" method=\"post\" action=\"".$_SESSION["lien"]."\">\n";    echo "<input type=\"hidden\" name=\"action\" value=\"sauvedata\">";    echo "<input type=\"hidden\" name=\"table\" value=\"".@$_SESSION["table"]."\">";    echo "<table>\n";    @reset($status);    while(list($key,$val) = each($status)){      if(is_string($key)){        if($key!="id"){          echo "<tr><td class=\"admin\" id=\"nom\">".strtoupper($key)."</td><td class=\"admin\" id=\"champs\"><input class=\"admin\" type=\"text\" name=\"form_".$key."\" value=\"";          if($key == "id"){echo $z;}          echo "\"></td></tr>\n";        }      }    }    echo "<tr><td colspan=\"2\" style=\"text-align:center;\"><input type=\"image\" value=\"Valider\" id=\"image32\" src =\"".$_SESSION["ico"]["valider"]."\" title=\"Cliquez pour valider\"></td></tr>\n";    echo "</table>\n";    echo "</form>\n";    echo "</div>\n";    unset($ligne);    unset($status);    unset($_SESSION["id"]);  break;}function cherche_droits(){  $x = "";  $result = @mysql_query("select * from tables order by nom asc")or die("erreur ".@$_SESSION["table"]." !");  while ($ligne = mysql_fetch_array($result)){    $x[$ligne["id"]] = $ligne;  }  return $x;}function lien_editer($val){  $temp = "<a title=\"Modifier\" href=\"javascript:voir('popup');ajaxpage(rootdomain+'scripts/inc.popup.php?table=".@$_SESSION["table"]."&acte=formulaire&formulaire=modifier&modifier=".$val[0]."','surpopup');loadobjs();\"><b>".$val[1]."</b>&nbsp;</a>";  return $temp;}function verif_droit_champs($droits,$champs,$table,$droits_champs){  $ok = 0;  while (list(, $test) = @each($droits_champs)){    if($test["nom"] == $champs && $test["droits"] == $droits && $test["lien"] == $table && $test["type"] == "droits"){      $ok = $test;    }  }  return $ok;}function verif_droit_table($droits,$table,$droits_table){  $ok = 0;  while (list(, $test) = @each($droits_table)){    if($test["nom"] == $table && $test["droits"] == $droits && $test["type"] == "droits"){      $ok = $test;    }  }  return $ok;}?>